<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Text Generator</title>
    <!-- Tailwind CSS via CDN (acceptable for development) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js 3.x via CDN with defer and without integrity attribute -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.3/dist/cdn.min.js"></script>
    <style>
        .preview-container {
            aspect-ratio: 16/9;
            background-color: black;
            position: relative;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen" x-data="app()">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Video Text Generator</h1>
            <p class="text-gray-600">Create stunning text animations with ease</p>
        </div>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto">
            <!-- Controls Card -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <form @submit.prevent="generateVideo" class="space-y-6">
                    <!-- Text Input -->
                    <div>
                        <label for="text_input" class="block text-sm font-medium text-gray-700 mb-2">Enter Text</label>
                        <input type="text" 
                               id="text_input" 
                               x-model="text" 
                               @input="updatePreview"
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Enter your text here">
                    </div>

                    <!-- Case Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Text Case</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" 
                                       x-model="case_var" 
                                       value="upper"
                                       @change="updatePreview"
                                       class="h-4 w-4 text-blue-600">
                                <span class="ml-2">Uppercase</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" 
                                       x-model="case_var" 
                                       value="lower"
                                       @change="updatePreview"
                                       class="h-4 w-4 text-blue-600">
                                <span class="ml-2">Lowercase</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" 
                                       x-model="case_var" 
                                       value="mixed"
                                       @change="updatePreview"
                                       class="h-4 w-4 text-blue-600">
                                <span class="ml-2">Mixed Case</span>
                            </label>
                        </div>
                    </div>

                    <!-- Character Size -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Character Size: <span x-text="char_size_var"></span>
                        </label>
                        <!-- Use x-model.number to bind as a number -->
                        <input type="range" 
                               x-model.number="char_size_var" 
                               @input="updatePreview"
                               min="50" 
                               max="400" 
                               step="10"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <!-- Character Spacing -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Character Spacing: <span x-text="char_spacing_var"></span>
                        </label>
                        <!-- Use x-model.number to bind as a number -->
                        <input type="range" 
                               x-model.number="char_spacing_var" 
                               @input="updatePreview"
                               min="-1" 
                               max="0" 
                               step="0.05"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <!-- Preview -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-700 mb-2">Preview</h3>
                        <div class="preview-container bg-black rounded-lg overflow-hidden relative">
                            <img 
                                 :src="previewUrl" 
                                 class="w-full h-full object-contain"
                                 alt="Preview">
                            <div x-show="loading"
                                 class="absolute inset-0 flex items-center justify-center">
                                <!-- Loading spinner SVG -->
                                <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </div>
                        </div>
                        <!-- Error Message Container -->
                        <div x-show="errorMessage" class="text-red-500 mt-4">
                            <p x-text="errorMessage"></p>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="flex justify-end">
                        <button type="submit" 
                                class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                :disabled="loading || generating"
                                :class="{ 'opacity-50 cursor-not-allowed': loading || generating }">
                            <span x-show="!generating">Generate Video</span>
                            <span x-show="generating">Generating...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Alpine.js Component Script -->
    <script>
        function app() {
            return {
                text: 'Sample Text',
                case_var: 'mixed',
                char_size_var: 300,
                char_spacing_var: -0.8,
                previewUrl: '',
                loading: false,
                generating: false,
                debounceTimeout: null,
                errorMessage: '',  // For displaying error messages

                async updatePreview() {
                    if (this.debounceTimeout) {
                        clearTimeout(this.debounceTimeout);
                    }

                    console.log("Updating preview...");

                    this.debounceTimeout = setTimeout(async () => {
                        if (!this.text) {
                            this.previewUrl = '';
                            console.log("No text provided. Clearing preview.");
                            this.errorMessage = 'Please enter some text to generate a preview.';
                            return;
                        }

                        this.loading = true;
                        this.errorMessage = '';  // Clear previous errors
                        console.log("Loading state set to true.");

                        try {
                            console.log("Character Size:", this.char_size_var);
                            console.log("Character Spacing:", this.char_spacing_var);
                            
                            const response = await fetch('/preview', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    text_input: this.text,
                                    case_var: this.case_var,
                                    char_size_var: this.char_size_var,
                                    char_spacing_var: this.char_spacing_var
                                })
                            });

                            if (response.ok) {
                                const data = await response.json();
                                if (data.preview_url) {
                                    if (this.previewUrl) {
                                        // Optionally, no need to revoke if using URL
                                        console.log("Previous preview URL exists.");
                                    }
                                    // To prevent caching, append a timestamp
                                    this.previewUrl = data.preview_url + `?t=${Date.now()}`;
                                    console.log("Preview URL updated:", this.previewUrl);
                                } else {
                                    this.errorMessage = 'Preview generation failed: No URL returned.';
                                    console.error('Preview generation failed: No URL returned.');
                                }
                            } else {
                                const errorData = await response.json();
                                console.error('Preview generation failed:', errorData.error);
                                this.errorMessage = 'Preview generation failed: ' + (errorData.error || 'Unknown error.');
                            }
                        } catch (error) {
                            console.error('Error generating preview:', error);
                            this.errorMessage = 'Error generating preview. Please check the console for details.';
                        } finally {
                            this.loading = false;
                            console.log("Loading state set to false.");
                        }
                    }, 500);  // Debounce delay
                },

                async generateVideo() {
                    this.generating = true;
                    console.log("Generating video...");

                    const formData = new FormData();
                    formData.append('text_input', this.text);
                    formData.append('case_var', this.case_var);
                    formData.append('char_size_var', this.char_size_var);
                    formData.append('char_spacing_var', this.char_spacing_var);

                    try {
                        const response = await fetch('/', {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `generated_${this.text}.mp4`;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            a.remove();
                            console.log("Video generated and download initiated.");
                        } else {
                            const errorText = await response.text();
                            alert('Video generation failed: ' + errorText);
                            console.error('Video generation failed:', errorText);
                        }
                    } catch (error) {
                        console.error('Error generating video:', error);
                        alert('Error generating video');
                    } finally {
                        this.generating = false;
                        console.log("Generating state set to false.");
                    }
                },

                init() {
                    this.updatePreview();
                }
            }
        }
    </script>
</body>
</html>
